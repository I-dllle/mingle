<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>í† ìŠ¤í˜ì´ë¨¼ì¸  ê²°ì œ</title>
    <script src="https://js.tosspayments.com/v2/standard"></script>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }

      .container {
        background: white;
        border-radius: 16px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        max-width: 500px;
        width: 100%;
        padding: 40px;
        position: relative;
        overflow: hidden;
      }

      .container::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, #0080ff, #00d4aa);
      }

      .header {
        text-align: center;
        margin-bottom: 30px;
      }

      .title {
        font-size: 24px;
        font-weight: 700;
        color: #191f28;
        margin-bottom: 8px;
      }

      .subtitle {
        color: #8b95a1;
        font-size: 14px;
      }

      .product-info {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 24px;
        border: 1px solid #e9ecef;
      }

      .product-name {
        font-size: 16px;
        font-weight: 600;
        color: #191f28;
        margin-bottom: 8px;
      }

      .product-price {
        font-size: 20px;
        font-weight: 700;
        color: #0080ff;
      }

      .coupon-section {
        margin: 24px 0;
        padding: 16px;
        background: #fff5e6;
        border-radius: 8px;
        border: 1px solid #ffd700;
      }

      .coupon-label {
        display: flex;
        align-items: center;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        color: #cc7a00;
      }

      .coupon-label input[type="checkbox"] {
        margin-right: 8px;
        transform: scale(1.2);
      }

      .payment-section {
        margin: 24px 0;
      }

      .section-title {
        font-size: 16px;
        font-weight: 600;
        color: #191f28;
        margin-bottom: 16px;
        padding-bottom: 8px;
        border-bottom: 1px solid #e9ecef;
      }

      #payment-method {
        margin-bottom: 24px;
        min-height: 200px;
      }

      #agreement {
        margin-bottom: 24px;
        min-height: 60px;
      }

      .payment-button {
        width: 100%;
        background: linear-gradient(135deg, #0080ff, #0066cc);
        border: none;
        border-radius: 12px;
        padding: 16px 24px;
        font-size: 16px;
        font-weight: 600;
        color: white;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 4px 12px rgba(0, 128, 255, 0.3);
      }

      .payment-button:hover {
        background: linear-gradient(135deg, #0066cc, #0052a3);
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(0, 128, 255, 0.4);
      }

      .payment-button:active {
        transform: translateY(0);
      }

      .loading {
        display: none;
        text-align: center;
        padding: 20px;
        color: #8b95a1;
      }

      .loading.show {
        display: block;
      }

      .spinner {
        width: 20px;
        height: 20px;
        border: 2px solid #e9ecef;
        border-top: 2px solid #0080ff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        display: inline-block;
        margin-right: 8px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .alert {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 8px;
        padding: 12px 16px;
        margin-bottom: 20px;
        color: #856404;
        font-size: 14px;
        display: flex;
        align-items: center;
      }

      .alert::before {
        content: "âš ï¸";
        margin-right: 8px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1 class="title">ê²°ì œí•˜ê¸°</h1>
        <p class="subtitle">ì•ˆì „í•˜ê³  ê°„í¸í•œ í† ìŠ¤í˜ì´ë¨¼ì¸ </p>
      </div>

      <div class="alert">í…ŒìŠ¤íŠ¸ í™˜ê²½ - ì‹¤ì œë¡œ ê²°ì œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</div>

      <!-- ìƒí’ˆ ì •ë³´ -->
      <div class="product-info">
        <div class="product-name" id="product-name">ìƒí’ˆëª… ë¡œë”©ì¤‘...</div>
        <div class="product-price" id="product-price">â‚©0</div>
      </div>

      <!-- í• ì¸ ì¿ í° -->
      <div class="coupon-section">
        <label class="coupon-label" for="coupon-box">
          <input type="checkbox" id="coupon-box" />
          ğŸŸï¸ 5,000ì› í• ì¸ ì¿ í° ì ìš©
        </label>
      </div>

      <!-- ê²°ì œ ë°©ë²• -->
      <div class="payment-section">
        <h3 class="section-title">ê²°ì œ ë°©ë²•</h3>
        <div id="payment-method"></div>
      </div>

      <!-- ì´ìš©ì•½ê´€ -->
      <div class="payment-section">
        <h3 class="section-title">ì•½ê´€ ë™ì˜</h3>
        <div id="agreement"></div>
      </div>

      <!-- ë¡œë”© í‘œì‹œ -->
      <div class="loading" id="loading">
        <div class="spinner"></div>
        ê²°ì œ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
      </div>

      <!-- ê²°ì œí•˜ê¸° ë²„íŠ¼ -->
      <button class="payment-button" id="payment-button">ê²°ì œí•˜ê¸°</button>
    </div>

    <script th:inline="javascript">
      // Thymeleafì—ì„œ ì „ë‹¬ë°›ì€ ë°ì´í„°
      const goodsData = /*[[${goods}]]*/ null;
      const orderIdData = /*[[${orderId}]]*/ null;
      const userData = /*[[${user}]]*/ null;

      console.log("ğŸ” ì›ë³¸ ë°ì´í„° í™•ì¸:");
      console.log("goodsData:", goodsData);
      console.log("orderIdData:", orderIdData);
      console.log("userData:", userData);

      // ìƒí’ˆ ì •ë³´ í‘œì‹œ
      let parsedGoods = null;
      if (goodsData) {
        parsedGoods =
          typeof goodsData === "string" ? JSON.parse(goodsData) : goodsData;
        console.log("ğŸ“¦ íŒŒì‹±ëœ ìƒí’ˆ ì •ë³´:", parsedGoods);
        console.log("ğŸ’° ìƒí’ˆ ì‹¤ì œ ê°€ê²©:", parsedGoods.itemPrice);

        document.getElementById("product-name").textContent =
          parsedGoods.itemName || "í…ŒìŠ¤íŠ¸ ìƒí’ˆ";
        document.getElementById("product-price").textContent = `â‚©${(
          parsedGoods.itemPrice || 50000
        ).toLocaleString()}`;
      }

      main();

      async function main() {
        try {
          const button = document.getElementById("payment-button");
          const coupon = document.getElementById("coupon-box");
          const loading = document.getElementById("loading");

          loading.classList.add("show");

          // ì•ˆì „í•œ ë°ì´í„° ì²˜ë¦¬
          console.log("ğŸš€ main() í•¨ìˆ˜ ì‹œì‘");
          console.log("goodsData:", goodsData);
          console.log("userData:", userData);
          console.log("orderIdData:", orderIdData);

          // ------  ê²°ì œìœ„ì ¯ ì´ˆê¸°í™” ------
          const clientKey = "test_gck_docs_Ovk5rk1EwkEbP0W43n07xlzm";
          const tossPayments = TossPayments(clientKey);

          // íšŒì› ê²°ì œ - ë” ì•ˆì „í•œ customerKey ìƒì„±
          let customerKey = "test-customer-123";
          if (userData && userData.id) {
            customerKey = userData.id.toString();
          }
          console.log("ğŸ‘¤ customerKey:", customerKey);

          const widgets = tossPayments.widgets({
            customerKey,
          });

          // ------ ì£¼ë¬¸ì˜ ê²°ì œ ê¸ˆì•¡ ì„¤ì • ------
          const baseAmount =
            parsedGoods && parsedGoods.itemPrice
              ? parsedGoods.itemPrice
              : 50000;
          console.log("ğŸ’µ ê²°ì œ ê¸°ë³¸ ê¸ˆì•¡ ì„¤ì •:", baseAmount);
          console.log("ğŸ’µ parsedGoods.itemPrice:", parsedGoods?.itemPrice);
          console.log("ğŸ’µ íƒ€ì… í™•ì¸:", typeof baseAmount);

          await widgets.setAmount({
            currency: "KRW",
            value: baseAmount,
          });

          console.log("âœ… í† ìŠ¤í˜ì´ë¨¼ì¸  ìœ„ì ¯ì— ì„¤ì •ëœ ê¸ˆì•¡:", baseAmount);

          await Promise.all([
            // ------  ê²°ì œ UI ë Œë”ë§ ------
            widgets.renderPaymentMethods({
              selector: "#payment-method",
              variantKey: "DEFAULT",
            }),
            // ------  ì´ìš©ì•½ê´€ UI ë Œë”ë§ ------
            widgets.renderAgreement({
              selector: "#agreement",
              variantKey: "AGREEMENT",
            }),
          ]);

          console.log("âœ… ê²°ì œ UI ë Œë”ë§ ì™„ë£Œ!");
          loading.classList.remove("show");

          // ------  ì£¼ë¬¸ì„œì˜ ê²°ì œ ê¸ˆì•¡ì´ ë³€ê²½ë˜ì—ˆì„ ê²½ìš° ê²°ì œ ê¸ˆì•¡ ì—…ë°ì´íŠ¸ ------
          coupon.addEventListener("change", async function () {
            const newAmount = coupon.checked ? baseAmount - 5000 : baseAmount;
            console.log("ğŸ« ì¿ í° ì ìš© ìƒíƒœ:", coupon.checked);
            console.log("ğŸ’° ì¿ í° ì ìš© í›„ ê¸ˆì•¡:", newAmount);

            await widgets.setAmount({
              currency: "KRW",
              value: newAmount,
            });

            // ê°€ê²© í‘œì‹œ ì—…ë°ì´íŠ¸
            document.getElementById(
              "product-price"
            ).textContent = `â‚©${newAmount.toLocaleString()}`;
          });

          // ------ 'ê²°ì œí•˜ê¸°' ë²„íŠ¼ ëˆ„ë¥´ë©´ ê²°ì œì°½ ë„ìš°ê¸° ------
          button.addEventListener("click", async function () {
            button.disabled = true;
            button.textContent = "ê²°ì œ ì§„í–‰ì¤‘...";

            // í˜„ì¬ ì¿ í° ìƒíƒœ í™•ì¸
            const currentAmount = coupon.checked
              ? baseAmount - 5000
              : baseAmount;
            console.log("ğŸ”¥ ê²°ì œ ë²„íŠ¼ í´ë¦­!");
            console.log("ğŸ”¥ ê¸°ë³¸ ê¸ˆì•¡:", baseAmount);
            console.log("ğŸ”¥ ì¿ í° ì ìš©ë¨?", coupon.checked);
            console.log("ğŸ”¥ ìµœì¢… ê²°ì œ ê¸ˆì•¡:", currentAmount);

            try {
              await widgets.requestPayment({
                orderId:
                  orderIdData ||
                  "test-order-" + Math.random().toString(36).substr(2, 9),
                orderName:
                  parsedGoods && parsedGoods.itemName
                    ? parsedGoods.itemName
                    : "í…ŒìŠ¤íŠ¸ ìƒí’ˆ",
                successUrl:
                  window.location.origin + "/api/v1/goodsOrder/success",
                failUrl: window.location.origin + "/api/v1/goodsOrder/fail",
                customerEmail:
                  userData && userData.email
                    ? userData.email
                    : "test@example.com",
                customerName:
                  userData && userData.name ? userData.name : "í…ŒìŠ¤íŠ¸ ì‚¬ìš©ì",
                customerMobilePhone:
                  userData && userData.phoneNumber
                    ? userData.phoneNumber
                    : "01012341234",
              });
            } catch (error) {
              console.error("âŒ ê²°ì œ ìš”ì²­ ì‹¤íŒ¨:", error);
              button.disabled = false;
              button.textContent = "ê²°ì œí•˜ê¸°";
            }
          });
        } catch (error) {
          console.error("âŒ ì´ˆê¸°í™” ì—ëŸ¬:", error);
          console.error("âŒ ì—ëŸ¬ ìŠ¤íƒ:", error.stack);
          document.getElementById("loading").innerHTML =
            '<span style="color: #dc3545;">âš ï¸ ê²°ì œ ì‹œìŠ¤í…œ ë¡œë”©ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</span>';
        }
      }
    </script>
  </body>
</html>
