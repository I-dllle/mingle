<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Presence ìƒíƒœ í…ŒìŠ¤íŠ¸</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 2rem;
    }
    button {
      margin: 0.25rem;
    }
    input {
      width: 400px;
    }
    pre {
      background: #f5f5f5;
      padding: 1rem;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>
<h2>âœ… Presence ìƒíƒœ í…ŒìŠ¤íŠ¸ í˜ì´ì§€</h2>

<label>ğŸ†” ìœ ì € ID:
  <input type="number" id="userId" value="1" />
</label>
<br /><br />

<label>ğŸ” JWT í† í°:
  <input type="text" id="token" placeholder="ì—¬ê¸°ì— Swaggerì—ì„œ ë°›ì€ JWTë¥¼ ë¶™ì—¬ë„£ê¸°" />
</label>
<br /><br />

<button onclick="connectWebSocket()">ğŸ”Œ WebSocket ì—°ê²°</button>
<button onclick="sendPing()">ğŸ’“ ping ì „ì†¡</button>
<button onclick="sendTabHidden()">ğŸ™ˆ tab_hidden ì „ì†¡</button>
<hr />

<button onclick="setManualStatus('ONLINE')">ğŸŸ¢ ìˆ˜ë™ í•´ì œ (ìë™ ë³µê·€)</button>
<button onclick="setManualStatus('AWAY')">ğŸŸ¡ ìë¦¬ë¹„ì›€ ì„¤ì •</button>
<button onclick="setManualStatus('DO_NOT_DISTURB')">ğŸš« ë°©í•´ê¸ˆì§€ ì„¤ì •</button>
<hr />

<button onclick="checkStatus()">ğŸ” ìƒíƒœ ì¡°íšŒ</button>
<pre id="result">[ìƒíƒœ ì¶œë ¥ ì˜ì—­]</pre>

<script>
  let socket;

  function connectWebSocket() {
    const token = document.getElementById("token").value;
    const roomId = "testroom"; // í…ŒìŠ¤íŠ¸ìš© roomId
    const url = `ws://localhost:8080/ws/chat/${roomId}?token=${token}`;

    socket = new WebSocket(url);

    socket.onopen = () => {
      console.log("âœ… WebSocket ì—°ê²°ë¨");
      alert("âœ… WebSocket ì—°ê²° ì„±ê³µ!");
    };
    socket.onmessage = (event) => {
      console.log("ğŸ“© ë©”ì‹œì§€ ìˆ˜ì‹ :", event.data);
    };
    socket.onclose = () => console.log("âŒ WebSocket ì¢…ë£Œ");
    socket.onerror = (e) => console.error("ğŸ”¥ WebSocket ì˜¤ë¥˜ ë°œìƒ", e);
  }

  function sendPing() {
    if (socket && socket.readyState === 1) {
      socket.send("ping");
      console.log("ğŸ’“ ping ì „ì†¡ë¨");
    } else {
      alert("âš ï¸ WebSocketì´ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
    }
  }

  function sendTabHidden() {
    if (socket && socket.readyState === 1) {
      socket.send("tab_hidden");
      console.log("ğŸ™ˆ tab_hidden ì „ì†¡ë¨");
    } else {
      alert("âš ï¸ WebSocketì´ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
    }
  }

  async function setManualStatus(status) {
    const token = document.getElementById("token").value;
    const res = await fetch("http://localhost:8080/api/v1/presence/manual-status", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${token}`,
      },
      body: JSON.stringify({ status }),
    });

    const resultEl = document.getElementById("result");
    if (res.ok) {
      resultEl.innerText = `âœ… ìˆ˜ë™ ìƒíƒœ "${status}" ì„¤ì • ì™„ë£Œ`;
    } else {
      const errText = await res.text();
      resultEl.innerText = `âŒ ìƒíƒœ ì„¤ì • ì‹¤íŒ¨ (${res.status})\n${errText}`;
    }
  }

  async function checkStatus() {
    const userId = document.getElementById("userId").value;
    const res = await fetch(`http://localhost:8080/api/v1/presence/${userId}`);
    const resultEl = document.getElementById("result");

    if (res.ok) {
      const data = await res.json();
      resultEl.innerText = JSON.stringify(data, null, 2);
    } else {
      resultEl.innerText = `âŒ ìƒíƒœ ì¡°íšŒ ì‹¤íŒ¨ (${res.status})`;
    }
  }
</script>
</body>
</html>
